"use strict";const BigBrother=function(){let e={},t={},i={"interpolate-for":{existingProperty:null,child:"watchers",callback:"interpolateForNode"},"view-if":{existingProperty:null,child:"watchers",callback:"viewIfNode"},"watch-text":{existingProperty:["textContent","innerText"],child:"watchers",callback:"watchNode"},"watch-value":{existingProperty:"value",child:"watchers",callback:"watchNode"},"watch-html":{existingProperty:"innerHTML",child:"watchers",callback:"watchNode"},"watch-class":{existingProperty:"className",child:"watchers",callback:"watchNode"},"watch-id":{existingProperty:"id",child:"watchers",callback:"watchNode"},"watch-name":{existingProperty:"name",child:"watchers",callback:"watchNode"},"listen-input":{existingProperty:"input",callback:"listenToNode"},"listen-click":{existingProperty:"click",callback:"listenToNode"},"listen-change":{existingProperty:"change",callback:"listenToNode"}},r={interpolateForNode({thinkpol:e,observable:t,observedProperty:i,node:r}){let s=r.parentNode,n=t[i],l=/\$\{key\}/g,o=/\$\{value\}/g;for(let a in n){let c=n[a],h=r.cloneNode(!0);for(let d of r.attributes){let u=d.nodeName,p=d.nodeValue.replace(l,a).replace(o,c);h.attributes[u].nodeValue=p}s.insertBefore(h,r),e.cleanDOM&&h.removeAttribute("interpolate-for")}s.removeChild(r)},viewIfNode({thinkpol:e,observable:t,observedProperty:i,node:r,watchKey:s}){e.unperson(t,i,r),e.watch(s,()=>e.unperson(t,i,r))},watchNode({thinkpol:e,observable:t,observedProperty:i,node:r,nodeProperty:s,watchKey:n}){r[s]=t[i],e.watch(n,()=>r[s]=t[i])},listenToNode({thinkpol:e,observable:t,observedProperty:i,node:r,nodeProperty:s}){r.addEventListener(s,r=>{void 0===t.listeners[i]?t.watchers[i]=r.target.value:t.listeners[i].call(e.personnelDetails(),r)},!0)}},s=e=>{let t={};for(let i of Object.keys(e)){let r=e[i];r instanceof Object&&!(r instanceof Function)&&null!==r?t[i]=s(r):t[i]=r}return t};class n{constructor(e,t){this.id=e.id,this.cleanDOM=t,this.data={id:e.id,listeners:e.listeners,watchers:s(e.watchers)},this.signals={},this.removed={},this.parent=void 0,this.children={}}setup(e,t,i){this.connectObservableProperties(this.data.watchers),this.collectNamedChildren(i),this.parseDOM(e,t,this.personnelDetails())}watch(e,t){this.signals[e]||(this.signals[e]=[]),this.signals[e].push(t)}notify(e){this.signals[e]&&!(this.signals[e].length<1)&&this.signals[e].forEach(function(e){e.call()})}unperson(e,t,i){if(e[t]){if(i in this.removed){let r=this.removed[i],s=r.parent,n=s.childNodes[r.index];s.insertBefore(i,n)}}else{let l=i.parentNode,o=Array.from(l.children).indexOf(i);this.removed[i]={parent:l,index:o},l.removeChild(i)}}personnelDetails(e=!0){let t={id:this.id,watchers:this.data.watchers,listeners:this.data.listeners};return e&&(t.parent=this.parent,t.children=this.children),t}connectObservableProperties(e,t){let i=this;for(let r in e)if(e.hasOwnProperty(r)){let s=e[r],n=void 0===t?r:`${t}.${r}`;if(s instanceof Object&&void 0===t){i.connectObservableProperties(s,n);continue}Object.defineProperty(e,r,{get:()=>s,set(e){s=e,i.notify(n)}})}}collectNamedChildren(e){let t=e.map(e=>`[designation][uuid="${e}"]`).join(",");if(""!==t)for(let i of document.querySelectorAll(t)){let r=i.attributes.designation.value,s=i.attributes.uuid.value;this.cleanDOM&&i.removeAttribute("designation"),this.children[r]=s}}parseDOM(e,t,s){for(let n in i){let l=i[n],o=r[l.callback],a=l.child,c=void 0!==a?s[a]:s,h=t.map(e=>`[${n}][uuid="${e}"]`).join(",");if(Array.isArray(l.existingProperty)){for(let d of l.existingProperty)this.observeNodeAttr(e,h,n,d,c,o);continue}this.observeNodeAttr(e,h,n,l.existingProperty,c,o)}}observeNodeAttr(e,t,i,r,s,n){if(t)for(let l of e.querySelectorAll(t)){let o=l.attributes[i].value,a=o.split("."),c={thinkpol:this,observable:s,observedProperty:o,node:l,nodeProperty:r,watchKey:o};if(this.cleanDOM&&l.removeAttribute(i),1===a.length){n(c);continue}let h=a.shift(),d=Object.assign({},s);for(let u of a)d=d[h],h=u;c.observable=d,c.observedProperty=h,n(c)}}}class l{constructor(e){this.partyMembersByUUID={},this.maxUUID=Number.MAX_SAFE_INTEGER-1,this.uuid=0,this.debug=e}load(){for(let e in this.loadRecursiveNodesWithParent(document.body),t){let i=t[e];i.parentNode.removeChild(i)}return this.partyMembersByUUID}loadRecursiveNodesWithParent(i,r=0,s){if(r>=1e3)return;let n=Array.from(i.childNodes);for(let l of n=n.filter(e=>1===e.nodeType&&"template"!==e.localName)){let o=l.localName;if(this.isExistingParent(o,s)){let a=i.localName;console.error(`Warning: "${a}" creates infinite recursion in "${o}"`);continue}let c=this.nextUUID();if(l.setAttribute("uuid",c),void 0!==s){if(void 0===e[o]){this.partyMembersByUUID[s].nodes.push(c);continue}this.partyMembersByUUID[s].children.push(c)}l.innerHTML=t[o].innerHTML,this.partyMembersByUUID[c]={id:o,parentUUID:s,debug:this.debug,nodes:[],children:[]},this.loadRecursiveNodesWithParent(l,r+1,c)}}isExistingParent(e,t){if(void 0===t)return!1;let i=this.partyMembersByUUID[t];for(let r=i;void 0!==t;r=this.partyMembersByUUID[t]){if(e===r.id)return!0;t=r.parentUUID}return!1}nextUUID(){if(this.uuid++,this.uuid>this.maxUUID)throw Error("UUID limit reached");return this.uuid}}return{registerPartyMember({id:i,watchers:r,listeners:s}){e[i]={id:i,watchers:r||{},listeners:s||{}},t[i]=`template[party-member="${i}"]`},beginWatching(i=!1){for(let[r,s]of Object.entries(t))t[r]=document.querySelector(s);let o=new l(i).load();for(let[a,c]of Object.entries(o)){let h=document.querySelector(`${c.id}[uuid="${a}"]`),d=e[c.id],u=new n(d,!c.debug);u.setup(h,c.nodes,c.children),c.inst=u}for(let p of Object.values(o)){let f=p.parentUUID;if(!f)continue;let b=o[f],y=p.inst.children;for(let[g,v]of(p.inst.parent=b.inst.personnelDetails(!1),Object.entries(y))){let m=o[v];y[g]=m.inst.personnelDetails(!1)}}}}}();